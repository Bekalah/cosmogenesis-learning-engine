<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cosmogenesis Learning Engine</title>
  <link rel="stylesheet" href="assets/css/core.css">
  <link rel="stylesheet" href="assets/css/hc.css">
</head>
<body>
  <header>
    <h1>Cosmogenesis Learning Engine</h1>
    <div class="controls">
      <label>Tilt <input id="tilt" type="range" min="0" max="45" step="0.5"></label>
      <label>Nodes <input id="nodes" type="number" min="33" max="144" step="1"></label>
      <label>Skin <select id="skin"></select></label>
      <button id="calm-toggle" aria-pressed="false">Calm Mode</button>
      <button id="hc-toggle" aria-pressed="false">High Contrast</button>
      <button id="btn-export">Export Plate</button>
    </div>
  </header>
  <main>
    <canvas id="stage" width="800" height="600"></canvas>
  </main>
  <footer>ND-safe • no autoplay • no strobe • honors reduced motion</footer>

  <script type="module">
    import { cfg, getStylepacks, getSpiralMap, getAngels } from './src/codex.ext.js';
    import ThemeEngine from './src/engines/theme-engine.js';
    import ArtEngine from './src/engines/art-engine.js';
    import SpiralEngine from './src/engines/spiral-engine.js';
    import { exportPlate } from './src/engines/exporter.js';
    import GuardianPlaque from './src/ui/guardian-plaque.js';
    import initInfoDot from './src/ui/info-dot.js';

    const canvas = document.getElementById('stage');
    const tiltInput = document.getElementById('tilt');
    const nodesInput = document.getElementById('nodes');
    const skinSelect = document.getElementById('skin');
    const calmBtn = document.getElementById('calm-toggle');
    const hcBtn = document.getElementById('hc-toggle');

    const themes = new ThemeEngine(getStylepacks());
    const art = new ArtEngine(canvas, themes);
    const spiral = new SpiralEngine(canvas, art);

    function applyState() {
      const tilt = parseFloat(localStorage.getItem('cosmo:v1:tilt') || '23.5');
      const nodes = parseInt(localStorage.getItem('cosmo:v1:nodes') || '33', 10);
      const skin = localStorage.getItem('cosmo:v1:skin') || 'AGRIPPA';
      const calm = localStorage.getItem('cosmo:v1:calm') === 'true';
      const hc = localStorage.getItem('cosmo:v1:hc') === 'true';
      tiltInput.value = tilt;
      nodesInput.value = nodes;
      skinSelect.value = skin;
      spiral.init({ tiltDeg: tilt, nodeCount: nodes, map: getSpiralMap() });
      themes.applyToElement(document.documentElement, skin);
      document.documentElement.dataset.calm = calm;
      document.documentElement.dataset.hc = hc;
      calmBtn.setAttribute('aria-pressed', calm);
      hcBtn.setAttribute('aria-pressed', hc);
    }

    tiltInput.addEventListener('input', e => {
      const v = parseFloat(e.target.value);
      spiral.setTilt(v);
      localStorage.setItem('cosmo:v1:tilt', v);
    });
    nodesInput.addEventListener('change', e => {
      let n = parseInt(e.target.value, 10);
      if (![33,72,144].includes(n)) n = 33;
      spiral.setNodeCount(n);
      localStorage.setItem('cosmo:v1:nodes', n);
    });
    skinSelect.addEventListener('change', e => {
      const id = e.target.value;
      themes.applyToElement(document.documentElement, id);
      localStorage.setItem('cosmo:v1:skin', id);
    });

    calmBtn.addEventListener('click', () => {
      const active = calmBtn.getAttribute('aria-pressed') === 'true';
      const next = !active;
      calmBtn.setAttribute('aria-pressed', next);
      document.documentElement.dataset.calm = next;
      localStorage.setItem('cosmo:v1:calm', next);
    });

    hcBtn.addEventListener('click', () => {
      const active = hcBtn.getAttribute('aria-pressed') === 'true';
      const next = !active;
      hcBtn.setAttribute('aria-pressed', next);
      if (next) document.documentElement.setAttribute('data-hc', 'true');
      else document.documentElement.removeAttribute('data-hc');
      localStorage.setItem('cosmo:v1:hc', next);
    });

    document.getElementById('btn-export').addEventListener('click', async () => {
      try {
        const map = getSpiralMap();
        const node = map.nodes[0];
        const res = await exportPlate({
          skin: skinSelect.value,
          nodeId: node?.id || 'n0',
          provenanceRefs: node?.payload.provenanceRefs || [],
          out: { width: 4096, format: 'png' }
        });
        const a = document.createElement('a');
        a.download = `${res.jsonSidecar.nodeId}.${'png'}`;
        a.href = URL.createObjectURL(res.blob);
        a.click();
        const j = document.createElement('a');
        j.download = `${res.jsonSidecar.nodeId}.json`;
        j.href = URL.createObjectURL(new Blob([JSON.stringify(res.jsonSidecar,null,2)],{type:'application/json'}));
        j.click();
      } catch (e) {
        plaque.open(e.message);
      }
    });

    const packs = getStylepacks();
    packs.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.name;
      skinSelect.appendChild(opt);
    });

    const plaque = new GuardianPlaque();
    initInfoDot();

    document.addEventListener('chamber:open', e => {
      const id = e.detail.id;
      const node = getSpiralMap().nodes.find(n => n.id === id);
      const angel = getAngels().find(a => a.id === node.guardian);
      plaque.open(`Angel of ${angel.title}, ${angel.mantra}`);
    });

    applyState();
    spiral.draw();
  </script>
</body>
</html>
