<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Cosmic Helix Renderer (ND-safe, Offline)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="color-scheme" content="light dark">
  <style>
    /* ND-safe: calm contrast, no motion, generous spacing */
    :root { --bg:#0b0b12; --ink:#e8e8f0; --muted:#a6a6c1; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--ink); font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    header { padding:12px 16px; border-bottom:1px solid #1d1d2a; }
    .status { color:var(--muted); font-size:12px; }
    #stage { display:block; margin:16px auto; box-shadow:0 0 0 1px #1d1d2a; }
    .note { max-width:900px; margin:0 auto 16px; color:var(--muted); }
    code { background:#11111a; padding:2px 4px; border-radius:3px; }
  </style>
</head>
<body>
  <header>
    <div><strong>Cosmic Helix Renderer</strong> — layered sacred geometry (offline, ND-safe)</div>
    <div class="status" id="status">Loading palette…</div>
  </header>

  <canvas id="stage" width="1440" height="900" aria-label="Layered sacred geometry canvas"></canvas>
  <p class="note">This static renderer encodes Vesica, Tree-of-Life, Fibonacci, and a static double-helix lattice. No animation, no autoplay, no external libs. Open this file directly.</p>

  <script type="module">
    import { renderHelix } from "./js/helix-renderer.mjs";

    const elStatus = document.getElementById("status");
    const canvas = document.getElementById("stage");
    const ctx = canvas.getContext("2d");

    const defaults = {
      // Fallback palette + registry ensures offline resilience when JSON files are missing.
      palette: {
        bg: "#0b0b12",
        ink: "#e8e8f0",
        layers: ["#b1c7ff", "#89f7fe", "#a0ffa1", "#ffd27f", "#f5a3ff", "#d0d0e6"]
      },
      registry: [
        { "id": 0, "name": "The Fool", "type": "arcana", "numerology": 0, "lore": "Pure potential, leap into the abyss, Aleph breath of beginning", "lab": "respawn-meditation" },
        { "id": 1, "name": "The Magician", "type": "arcana", "numerology": 1, "lore": "Will manifested, Mercury's messenger, tools of transformation", "lab": "beth-house-ritual" },
        { "id": 2, "name": "High Priestess", "type": "arcana", "numerology": 2, "lore": "Veiled wisdom, lunar mysteries, guardian of thresholds", "lab": "gimel-camel-path" },
        { "id": 3, "name": "The Empress", "type": "arcana", "numerology": 3, "lore": "Venus fertile, creative abundance, nature's sovereignty" },
        { "id": 4, "name": "The Emperor", "type": "arcana", "numerology": 4, "lore": "Cubic throne, Mars authority, structure and order" },
        { "id": 5, "name": "Hierophant", "type": "arcana", "numerology": 5, "lore": "Taurus teaching, bridge between worlds, sacred tradition" },
        { "id": 6, "name": "The Lovers", "type": "arcana", "numerology": 6, "lore": "Zayin sword divides, conscious choice, sacred union" },
        { "id": 7, "name": "The Chariot", "type": "arcana", "numerology": 7, "lore": "Cancer's shell, sphinx guardians, triumphant will" },
        { "id": 8, "name": "Strength", "type": "arcana", "numerology": 8, "lore": "Serpent power, Leo's courage, infinite lemniscate" },
        { "id": 9, "name": "Hermit", "type": "arcana", "numerology": 9, "lore": "Virgo's lamp, Yod hand of God, inner guidance" },
        { "id": 10, "name": "Wheel of Fortune", "type": "arcana", "numerology": 10, "lore": "Jupiter's expansion, karma cycles, sphinx wisdom" },
        { "id": 11, "name": "Justice", "type": "arcana", "numerology": 11, "lore": "Libra's balance, Lamed ox-goad, karmic adjustment" },
        { "id": 12, "name": "Hanged Man", "type": "arcana", "numerology": 12, "lore": "Neptune's water, suspended mind, reversal wisdom" },
        { "id": 13, "name": "Death", "type": "arcana", "numerology": 13, "lore": "Scorpio transformation, Nun fish, ego dissolution", "lab": "death-rebirth" },
        { "id": 14, "name": "Temperance", "type": "arcana", "numerology": 14, "lore": "Sagittarius arrow, alchemical mixture, middle path" },
        { "id": 15, "name": "Devil", "type": "arcana", "numerology": 15, "lore": "Capricorn matter, Ayin eye opens, shadow integration" },
        { "id": 16, "name": "Tower", "type": "arcana", "numerology": 16, "lore": "Mars lightning, false crown falls, liberation shock", "lab": "tower-catalyst" },
        { "id": 17, "name": "Star", "type": "arcana", "numerology": 17, "lore": "Aquarius pours, seven chakras, cosmic consciousness" },
        { "id": 18, "name": "Moon", "type": "arcana", "numerology": 18, "lore": "Pisces dreams, Qoph back of head, astral journey", "lab": "moon-veil" },
        { "id": 19, "name": "Sun", "type": "arcana", "numerology": 19, "lore": "Solar child, Resh head renewal, conscious joy" },
        { "id": 20, "name": "Judgement", "type": "arcana", "numerology": 20, "lore": "Pluto rises, Shin tooth/fire, eternal calling" },
        { "id": 21, "name": "World", "type": "arcana", "numerology": 21, "lore": "Saturn completes, Tau cross manifest, cosmic dance" },
        { "id": 22, "name": "Kether", "type": "sephirah", "numerology": 1, "lore": "Crown unity, source point, pure will undifferentiated" },
        { "id": 23, "name": "Chokmah", "type": "sephirah", "numerology": 2, "lore": "Wisdom force, Zodiac sphere, active principle" },
        { "id": 24, "name": "Binah", "type": "sephirah", "numerology": 3, "lore": "Understanding form, Saturn's restriction, divine mother" },
        { "id": 25, "name": "Chesed", "type": "sephirah", "numerology": 4, "lore": "Jupiter mercy, building power, benevolent king" },
        { "id": 26, "name": "Geburah", "type": "sephirah", "numerology": 5, "lore": "Mars severity, destroying force, necessary restriction" },
        { "id": 27, "name": "Tiphareth", "type": "sephirah", "numerology": 6, "lore": "Solar beauty, Christ center, harmonious balance" },
        { "id": 28, "name": "Netzach", "type": "sephirah", "numerology": 7, "lore": "Venus victory, desire nature, creative force" },
        { "id": 29, "name": "Hod", "type": "sephirah", "numerology": 8, "lore": "Mercury splendor, mental forms, magical image" },
        { "id": 30, "name": "Yesod", "type": "sephirah", "numerology": 9, "lore": "Lunar foundation, astral light, subconscious machinery" },
        { "id": 31, "name": "Malkuth", "type": "sephirah", "numerology": 10, "lore": "Kingdom manifest, four elements, physical completion" },
        { "id": 32, "name": "Aleph Path", "type": "path", "numerology": 11, "lore": "Fool's breath, Kether to Chokmah, spirit descends" },
        { "id": 33, "name": "Beth Path", "type": "path", "numerology": 12, "lore": "Magician's house, Kether to Binah, will directed" },
        { "id": 34, "name": "Gimel Path", "type": "path", "numerology": 13, "lore": "Priestess veil, Kether to Tiphareth, unity to beauty" },
        { "id": 35, "name": "Daleth Path", "type": "path", "numerology": 14, "lore": "Empress door, Chokmah to Binah, wisdom meets form" },
        { "id": 36, "name": "Samekh Path", "type": "path", "numerology": 25, "lore": "Temperance arrow, Tiphareth to Yesod, testing ground" },
        { "id": 37, "name": "Ayin Path", "type": "path", "numerology": 26, "lore": "Devil's eye, Tiphareth to Hod, material test" },
        { "id": 38, "name": "Peh Path", "type": "path", "numerology": 27, "lore": "Tower's mouth, Netzach to Hod, force meets form" },
        { "id": 39, "name": "Tzaddi Path", "type": "path", "numerology": 28, "lore": "Star's hook, Netzach to Yesod, desire crystallizes" },
        { "id": 40, "name": "Qoph Path", "type": "path", "numerology": 29, "lore": "Moon's sleep, Netzach to Malkuth, dream manifest" },
        { "id": 41, "name": "Shin Path", "type": "path", "numerology": 31, "lore": "Judgement fire, Hod to Malkuth, mind materializes" },
        { "id": 42, "name": "Tau Path", "type": "path", "numerology": 32, "lore": "World's cross, Yesod to Malkuth, foundation complete" }
      ]
    };

    const NUM = {
      THREE: 3,
      SEVEN: 7,
      NINE: 9,
      ELEVEN: 11,
      TWENTYTWO: 22,
      THIRTYTHREE: 33,
      NINETYNINE: 99,
      ONEFORTYFOUR: 144
    };

    initialise();

    async function initialise() {
      const paletteData = await loadJSON("./data/palette.json");
      const registryData = await loadJSON("./data/cosmic-nodes.json");

      const activePalette = paletteData || defaults.palette;
      const activeRegistry = registryData || defaults.registry;

      applyChromePalette(activePalette);

      const statusParts = [];
      const notices = [];

      if (paletteData) {
        statusParts.push("Palette loaded.");
      } else {
        statusParts.push("Palette missing; using safe fallback.");
        notices.push("Palette fallback active");
      }

      if (registryData) {
        statusParts.push("Registry loaded.");
      } else {
        statusParts.push("Registry missing; using sealed dataset.");
        notices.push("Registry fallback active");
      }

      elStatus.textContent = statusParts.join(" ");

      if (!ctx) {
        elStatus.textContent += " Canvas 2D context unavailable.";
        return;
      }

      // ND-safe: renderer executes once with static geometry and optional notices when fallbacks are active.
      renderHelix(ctx, {
        width: canvas.width,
        height: canvas.height,
        palette: activePalette,
        registry: activeRegistry,
        NUM,
        notice: notices.length ? notices.join(" · ") : null
      });
    }

    async function loadJSON(path) {
      if (typeof path !== "string") return null;

      // Offline-first: when opened via file:// prefer JSON modules to avoid fetch restrictions.
      if (window.location && window.location.protocol === "file:") {
        try {
          const module = await import(path, { assert: { type: "json" } });
          return module && typeof module.default !== "undefined" ? module.default : module;
        } catch (err) {
          return null;
        }
      }

      try {
        const res = await fetch(path, { cache: "no-store" });
        if (!res.ok) return null;
        return await res.json();
      } catch (err) {
        return null;
      }
    }

    function applyChromePalette(palette) {
      document.documentElement.style.setProperty("--bg", palette.bg);
      document.documentElement.style.setProperty("--ink", palette.ink);
      const muted = Array.isArray(palette.layers) && palette.layers.length > 0
        ? palette.layers[palette.layers.length - 1]
        : palette.ink;
      document.documentElement.style.setProperty("--muted", muted);
    }
  </script>
</body>
</html>
