<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Cosmogenesis Learning Engine</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="ND-safe atelier index for the Cosmogenesis Learning Engine.">
  <style>
    :root {
      --noir-absolu:#05050c;
      --encre:#f5f4ff;
      --encre-dim:#a5a8c6;
      --violet-ray:#8f7bff;
      --violet-deep:#4f3ea0;
      --dorure:#d6b87c;
      --verre:#131321;
      --ombre:#0b0b16;
      --focus:#8cc7ff;
    }

    /* unified body rule */
    body{
      font-family:'Bodoni Moda','Didot',Georgia,serif;
      background:radial-gradient(circle at 20% 20%,rgba(143,123,255,0.08),transparent 60%),linear-gradient(135deg,var(--noir-absolu) 0%,var(--ombre) 50%,#111228 100%);
      color:var(--encre);
      overflow-x:hidden;
      margin:0;
      min-height:100vh;

      /* custom cursor */
      cursor:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="2" fill="white"/><circle cx="16" cy="16" r="8" fill="none" stroke="white" stroke-width="0.5" opacity="0.5"/></svg>'),auto;
    }

    /* accessibility helpers */
    .skip-link{position:absolute;left:-9999px;top:auto}
    .skip-link:focus{left:1rem;top:1rem;background:#000;color:#fff;padding:.5rem 1rem;z-index:10001;border-radius:999px}

    #sacred-canvas{position:fixed;inset:0;z-index:-2;opacity:.32}

    .atelier-nav{
      position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;gap:2rem;padding:1.2rem clamp(1.5rem,4vw,4rem);background:rgba(8,7,18,0.72);backdrop-filter:saturate(140%) blur(16px);border-bottom:1px solid rgba(214,184,124,0.25);z-index:1000;
    }
    .marque-logo{font-size:1.2rem;font-weight:600;letter-spacing:.28em;text-transform:uppercase;color:var(--encre);text-decoration:none}
    .nav-collection{list-style:none;display:flex;gap:1.5rem;margin:0;padding:0}
    .nav-collection a{color:var(--encre-dim);text-decoration:none;font-size:.95rem;letter-spacing:.08em;text-transform:uppercase}
    .nav-collection a:focus-visible,.nav-collection a:hover{color:var(--dorure)}
    .btn-couture{background:transparent;border:1px solid var(--dorure);color:var(--dorure);padding:.6rem 1.4rem;border-radius:999px;font-size:.9rem;letter-spacing:.12em;text-transform:uppercase;cursor:pointer}
    .btn-couture:focus-visible{outline:3px solid var(--focus);outline-offset:2px}

    main{padding:clamp(3rem,6vw,5rem) clamp(1.5rem,6vw,6rem);display:grid;gap:clamp(4rem,6vw,6rem)}

    .hero{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));align-items:center;gap:clamp(2rem,5vw,6rem)}
    .hero-copy{display:grid;gap:1rem}
    .hero-title{margin:0;font-size:clamp(2.8rem,6vw,4.6rem);letter-spacing:.32em}
    .hero-subtitle{margin:0;font-size:1.1rem;color:var(--encre-dim);max-width:40ch;line-height:1.6}
    .hero-actions{display:flex;gap:1rem;flex-wrap:wrap;margin-top:1rem}
    .btn-outline{display:inline-flex;align-items:center;justify-content:center;padding:.7rem 1.5rem;border:1px solid var(--encre-dim);border-radius:999px;color:var(--encre);text-decoration:none;letter-spacing:.1em;text-transform:uppercase;font-size:.9rem}
    .btn-outline:hover,.btn-outline:focus-visible{border-color:var(--dorure);color:var(--dorure)}

    .loading-sigil{width:140px;height:140px;border-radius:50%;margin-inline:auto;border:1px solid rgba(214,184,124,0.4);display:grid;place-items:center;position:relative;box-shadow:0 0 40px rgba(79,62,160,0.25);animation:sigil-spin 24s linear infinite}
    .loading-sigil::before,.loading-sigil::after{content:"";position:absolute;border-radius:50%;border:1px solid rgba(143,123,255,0.35)}
    .loading-sigil::before{inset:12%;box-shadow:0 0 20px rgba(143,123,255,0.2)}
    .loading-sigil::after{inset:24%;border-color:rgba(214,184,124,0.35)}
    .loading-sigil span{width:4px;height:40%;background:linear-gradient(180deg,var(--violet-ray),transparent);transform-origin:50% 100%;animation:sigil-rays 18s linear infinite}

    @keyframes sigil-spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    @keyframes sigil-rays{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

    .section{display:grid;gap:1.5rem}
    .section-titre{font-size:clamp(1.6rem,3vw,2.4rem);letter-spacing:.22em;margin:0;text-transform:uppercase}
    .section-sous-titre{margin:0;color:var(--encre-dim);font-size:1.05rem;max-width:60ch}

    .module-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.6rem}
    .module-card{background:rgba(17,17,32,0.8);border:1px solid rgba(214,184,124,0.2);border-radius:18px;padding:1.6rem;display:grid;gap:1rem;position:relative;overflow:hidden;box-shadow:0 18px 50px rgba(11,11,22,0.6);transition:transform .35s ease, box-shadow .35s ease, border-color .35s ease}
    .module-card::before{content:"";position:absolute;inset:-60% -20%;background:radial-gradient(circle,rgba(143,123,255,0.22),transparent 65%);animation:slow-rotate 28s linear infinite;mix-blend-mode:screen}
    .module-card:hover,.module-card:focus-within{transform:translateY(-6px);border-color:var(--dorure);box-shadow:0 26px 60px rgba(79,62,160,0.45)}
    .module-title{margin:0;font-size:1.35rem;letter-spacing:.1em;display:flex;align-items:center;gap:.6rem}
    .module-description{margin:0;color:var(--encre-dim);line-height:1.7;font-size:.95rem}
    .module-tags{display:flex;flex-wrap:wrap;gap:.5rem}
    .tag{padding:.3rem .8rem;border-radius:999px;background:rgba(79,62,160,0.28);border:1px solid rgba(143,123,255,0.25);font-size:.75rem;letter-spacing:.08em;color:var(--encre-dim)}

    @keyframes slow-rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

    .geometry-lab{background:rgba(17,17,36,0.74);border:1px solid rgba(143,123,255,0.25);border-radius:20px;padding:1.5rem;display:grid;gap:1.4rem;box-shadow:0 18px 50px rgba(8,8,20,0.65)}
    .geometry-frame{position:relative;border:1px solid rgba(214,184,124,0.28);border-radius:16px;overflow:hidden;background:rgba(7,7,16,0.65)}
    .geometric-canvas{display:block;width:100%;height:360px}
    .control-panel{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem}
    .control-group{display:grid;gap:.4rem}
    .control-label{text-transform:uppercase;letter-spacing:.08em;font-size:.75rem;color:var(--dorure)}
    .control-slider{-webkit-appearance:none;height:6px;border-radius:3px;background:rgba(143,123,255,0.35);outline:0}
    .control-slider::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--dorure);box-shadow:0 0 12px rgba(214,184,124,0.5);cursor:pointer}

    .research-list{list-style:none;margin:0;padding:0;display:grid;gap:.8rem}
    .research-list a{color:var(--dorure);text-decoration:none;letter-spacing:.08em}
    .research-list a:focus-visible,.research-list a:hover{color:var(--violet-ray)}

    .healing-interface{background:rgba(13,13,26,0.7);border:1px solid rgba(143,123,255,0.25);border-radius:18px;padding:1.6rem;display:grid;gap:1.2rem}
    .frequency-display{font-family:"Roboto Mono",ui-monospace,monospace;text-align:center;font-size:1.6rem;color:var(--dorure)}
    .color-palette{display:flex;flex-wrap:wrap;gap:.6rem;justify-content:center}
    .color-swatch{width:48px;height:48px;border-radius:50%;border:2px solid transparent;cursor:pointer}
    .color-swatch:focus-visible,.color-swatch:hover{border-color:var(--dorure)}

    .journal-entry{background:rgba(18,18,32,0.82);border-left:3px solid var(--violet-ray);padding:1.2rem;border-radius:12px;color:var(--encre-dim);line-height:1.7}
    .journal-date{font-size:.85rem;letter-spacing:.1em;text-transform:uppercase;color:var(--dorure);margin-bottom:.5rem}

    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(5,5,12,0.86);backdrop-filter:blur(10px);z-index:2000}
    .modal[hidden]{display:none}
    .modal-content{background:linear-gradient(160deg,rgba(17,17,36,0.95),rgba(56,42,120,0.95));border:1px solid rgba(214,184,124,0.35);border-radius:18px;padding:2rem;max-width:520px;width:min(90vw,520px);box-shadow:0 30px 90px rgba(0,0,0,0.6)}
    .close-modal{background:none;border:none;color:var(--encre-dim);font-size:1.4rem;cursor:pointer;position:absolute;top:1.2rem;right:1.2rem}
    .close-modal:hover,.close-modal:focus-visible{color:var(--dorure)}
    .modal-title{margin-top:0;letter-spacing:.12em;text-transform:uppercase}
    .modal-body{color:var(--encre-dim);line-height:1.7}

    .maison-footer{margin:4rem 0 2.5rem;text-align:center;color:var(--encre-dim);font-size:.85rem;letter-spacing:.08em;display:grid;gap:.8rem}
    .footer-links{display:flex;flex-wrap:wrap;justify-content:center;gap:1.2rem}
    .footer-links a{color:var(--encre-dim);text-decoration:none}
    .footer-links a:hover,.footer-links a:focus-visible{color:var(--dorure)}

    /* ND-safe: freeze ALL animations when reduced motion is set */
    .reduced-motion *{animation:none!important;transition:none!important}
    .reduced-motion .geometric-canvas::before,
    .reduced-motion .geometric-canvas::after{animation:none!important}
    .reduced-motion .loading-sigil{animation:none!important}
    .reduced-motion .module-card::before{animation:none!important}

    @media (prefers-reduced-motion: reduce){
      .loading-sigil{animation:none}
      .module-card::before{animation:none}
    }

    @media (max-width:900px){
      .nav-collection{gap:1rem}
      .btn-couture{display:none}
    }
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to content</a>

  <nav class="atelier-nav">
    <a href="#collections" class="marque-logo">COSMOGENESIS</a>
    <ul class="nav-collection">
      <li><a href="#collections">Collections</a></li>
      <li><a href="#arcana">Living Arcana</a></li>
      <li><a href="#node-system">Node System</a></li>
      <li><a href="#research">Research</a></li>
      <li><a href="#atelier">Atelier</a></li>
    </ul>
    <button id="calmToggle" class="btn-couture" aria-pressed="false">Calm Mode</button>
  </nav>

  <canvas id="sacred-canvas" aria-hidden="true"></canvas>

  <main id="main">
    <section id="collections" class="hero" aria-labelledby="hero-title">
      <div class="hero-copy">
        <h1 id="hero-title" class="hero-title">COSMOGENESIS</h1>
        <p class="hero-subtitle">A couture codex weaving sacred geometry, trauma-informed pedagogy, and living arcana registries. Every layer breathes slowly and honours ND-safe pacing.</p>
        <div class="hero-actions">
          <a class="btn-outline" href="#arcana">Explore Collections</a>
          <a class="btn-outline" href="#atelier">Enter Atelier</a>
        </div>
      </div>
      <div class="loading-sigil" aria-hidden="true"><span></span></div>
    </section>

    <section id="arcana" class="section" aria-labelledby="arcana-title">
      <h2 id="arcana-title" class="section-titre">Living Arcana</h2>
      <p class="section-sous-titre">Key codex collections bridging art, learn, and play. Hover or focus to open the modal chapel&mdash;no autoplay, only annotated pathways.</p>
      <div class="module-grid">
        <article class="module-card" tabindex="0" data-title="Cosmogenesis Patterns" data-description="Explore creation myths through neurodivergent pattern recognition. Map sacred geometry of universe birthing across cultures.">
          <h3 class="module-title">Cosmogenesis Patterns</h3>
          <p class="module-description">Explore creation myths through neurodivergent pattern recognition. Map sacred geometry of universe birthing across cultures.</p>
          <div class="module-tags">
            <span class="tag">Sacred Geometry</span>
            <span class="tag">Creation Myths</span>
            <span class="tag">ND Cognition</span>
          </div>
        </article>
        <article class="module-card" tabindex="0" data-title="Harmonic Resonance Lab" data-description="Investigate Schumann resonances, planetary frequencies, and solfeggio tones. Create custom frequency environments.">
          <h3 class="module-title">Harmonic Resonance Lab</h3>
          <p class="module-description">Investigate Schumann resonances, planetary frequencies, and solfeggio tones. Create custom frequency environments.</p>
          <div class="module-tags">
            <span class="tag">Sound Healing</span>
            <span class="tag">Frequency</span>
            <span class="tag">Binaural</span>
          </div>
        </article>
        <article class="module-card" tabindex="0" data-title="Symbolic Cognition Archive" data-description="Art-science fusion: Red Book, temple geometry, synesthetic archives--curated for nonlinear minds.">
          <h3 class="module-title">Symbolic Cognition Archive</h3>
          <p class="module-description">Art-science fusion. Study Red Book, temple geometry, synesthetic archives.</p>
          <div class="module-tags">
            <span class="tag">Jung</span>
            <span class="tag">Symbolism</span>
            <span class="tag">ND Minds</span>
          </div>
        </article>
        <article class="module-card" tabindex="0" data-title="Trauma-Safe Spaces" data-description="Design healing environments with polyvagal theory, biophilic patterns, and RPG mechanics for regulation.">
          <h3 class="module-title">Trauma-Safe Spaces</h3>
          <p class="module-description">Design healing environments with polyvagal theory, biophilic patterns, and RPG mechanics for regulation.</p>
          <div class="module-tags">
            <span class="tag">PTSD</span>
            <span class="tag">Healing</span>
            <span class="tag">Safe Space</span>
          </div>
        </article>
        <article class="module-card" tabindex="0" data-title="Alchemical Psychology" data-description="In the line of Fortune, Case, Agrippa. Transform lead awareness into gold through layered praxis.">
          <h3 class="module-title">Alchemical Psychology</h3>
          <p class="module-description">In the line of Fortune, Case, Agrippa. Transform lead awareness into gold.</p>
          <div class="module-tags">
            <span class="tag">Alchemy</span>
            <span class="tag">Theosophy</span>
            <span class="tag">Mysticism</span>
          </div>
        </article>
        <article class="module-card" tabindex="0" data-title="Living Arcana System" data-description="Dynamic Tarot <-> Tree correspondences. Real-time archetypal pattern synthesis.">
          <h3 class="module-title">Living Arcana System</h3>
          <p class="module-description">Dynamic Tarot <-> Tree correspondences. Real-time archetypal pattern synthesis.</p>
          <div class="module-tags">
            <span class="tag">Tarot</span>
            <span class="tag">Qabalah</span>
            <span class="tag">Hermetic</span>
          </div>
        </article>
      </div>
    </section>

    <section id="node-system" class="section" aria-labelledby="node-title">
      <h2 id="node-title" class="section-titre">Node System Laboratory</h2>
      <p class="section-sous-titre">Layered geometry studio&mdash;calibrated to numerology constants {3, 7, 9, 11, 22, 33, 99, 144}. Motion pauses when Calm Mode is active.</p>
      <div class="geometry-lab">
        <div class="geometry-frame">
          <canvas id="geometry-canvas" class="geometric-canvas" aria-label="Geometry canvas"></canvas>
        </div>
        <div class="control-panel" role="group" aria-label="Geometry controls">
          <div class="control-group">
            <label class="control-label" for="recursion">Recursion Depth</label>
            <input id="recursion" type="range" class="control-slider" min="1" max="12" value="6">
          </div>
          <div class="control-group">
            <label class="control-label" for="phi">Golden Ratio (phi)</label>
            <input id="phi" type="range" class="control-slider" min="0" max="100" value="61">
          </div>
          <div class="control-group">
            <label class="control-label" for="rotation">Rotation Speed</label>
            <input id="rotation" type="range" class="control-slider" min="0" max="100" value="30">
          </div>
          <div class="control-group">
            <label class="control-label" for="complexity">Fractal Complexity</label>
            <input id="complexity" type="range" class="control-slider" min="3" max="24" value="12">
          </div>
        </div>
      </div>
    </section>

    <section id="research" class="section" aria-label="Research Index">
      <h2 class="section-titre">Research Index</h2>
      <p class="section-sous-titre">Primary scrolls and datasets for provenance-first study.</p>
      <ul class="research-list">
        <li><a href="scrolls/index.html">Scrolls - Provenance excerpts</a></li>
        <li><a href="about/index.html">About the Cosmogenesis Learning Engine</a></li>
        <li><a href="../docs/aurora_gate_node_00.html">Aurora Gate node dossier (docs)</a></li>
      </ul>
    </section>

    <section id="atelier" class="section" aria-labelledby="atelier-title">
      <h2 id="atelier-title" class="section-titre">Atelier Harmonics</h2>
      <p class="section-sous-titre">Colour-frequency chamber and field notes. Everything remains static until you interact.</p>
      <div class="healing-interface">
        <div class="frequency-display" id="freqReadout">432 Hz</div>
        <div id="palette" class="color-palette" aria-live="polite">
          <button class="color-swatch" style="background:#FF0000" data-freq="428" aria-label="Red 428 Hz"></button>
          <button class="color-swatch" style="background:#FFA500" data-freq="480" aria-label="Orange 480 Hz"></button>
          <button class="color-swatch" style="background:#FFFF00" data-freq="510" aria-label="Yellow 510 Hz"></button>
          <button class="color-swatch" style="background:#00FF00" data-freq="528" aria-label="Green 528 Hz"></button>
          <button class="color-swatch" style="background:#00FFFF" data-freq="600" aria-label="Cyan 600 Hz"></button>
          <button class="color-swatch" style="background:#0000FF" data-freq="660" aria-label="Blue 660 Hz"></button>
          <button class="color-swatch" style="background:#8B00FF" data-freq="720" aria-label="Violet 720 Hz"></button>
        </div>
      </div>
      <article class="journal-entry" aria-label="Research Journal Entry">
        <div class="journal-date">Entry 144 - Timestamp: Now</div>
        <div>The engine awakens. Patterns emerge where ancient wisdom meets experimental research. The Tree of Life navigates layers of consciousness; the Codex 144:99 frames completion (144) meeting the open spiral (99).</div>
      </article>
    </section>
  </main>

  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" hidden>
    <div class="modal-content">
      <button type="button" class="close-modal" aria-label="Close modal">Close</button>
      <h3 id="modal-title" class="modal-title"></h3>
      <p id="modal-body" class="modal-body"></p>
    </div>
  </div>

  <footer class="maison-footer">
    <div class="footer-links">
      <a href="#collections">Harmonic Research</a>
      <a href="#node-system">Node System Docs</a>
      <a href="https://github.com/Rebecca-Respawn/cosmogenesis-learning-engine" rel="noopener noreferrer">Open Source</a>
      <a href="#atelier">Commissions</a>
    </div>
    <p class="copyright">&copy; MMXXV &mdash; Atelier of Sacred Geometry &amp; Consciousness Research</p>
  </footer>

  <script>
    const root = document.documentElement;
    const calmBtn = document.getElementById('calmToggle');
    const prefersReducedMotion = typeof window !== 'undefined' && typeof window.matchMedia === 'function'
      ? window.matchMedia('(prefers-reduced-motion: reduce)')
      : null;

    function setCalmButtonState() {
      if (calmBtn) {
        calmBtn.setAttribute('aria-pressed', String(root.classList.contains('reduced-motion')));
      }
    }

    if (prefersReducedMotion && prefersReducedMotion.matches) {
      root.classList.add('reduced-motion');
    }
    setCalmButtonState();

    const handlePreferenceChange = (event) => {
      root.classList.toggle('reduced-motion', event.matches);
      refreshMotionState();
    };

    if (prefersReducedMotion) {
      if (typeof prefersReducedMotion.addEventListener === 'function') {
        prefersReducedMotion.addEventListener('change', handlePreferenceChange);
      } else if (typeof prefersReducedMotion.addListener === 'function') {
        prefersReducedMotion.addListener(handlePreferenceChange);
      }
    }

    calmBtn?.addEventListener('click', () => {
      root.classList.toggle('reduced-motion');
      refreshMotionState();
    });

    const bgCanvas = document.getElementById('sacred-canvas');
    const bgCtx = bgCanvas ? bgCanvas.getContext('2d') : null;
    const particles = [];
    let bgAnimationId = null;

    function resizeBg() {
      if (!bgCanvas) return;
      bgCanvas.width = window.innerWidth;
      bgCanvas.height = window.innerHeight;
    }

    function seedParticles() {
      if (!bgCanvas) return;
      particles.length = 0;
      const count = root.classList.contains('reduced-motion') ? 12 : 48;
      for (let i = 0; i < count; i += 1) {
        particles.push({
          x: Math.random() * bgCanvas.width,
          y: Math.random() * bgCanvas.height,
          vx: (Math.random() - 0.5) * 0.28,
          vy: (Math.random() - 0.5) * 0.28,
          r: Math.random() * 2 + 0.6,
          life: Math.random() * 0.8 + 0.2
        });
      }
    }

    function drawBackdrop() {
      if (!bgCanvas || !bgCtx) return;
      bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
      particles.forEach((p) => {
        p.x += p.vx;
        p.y += p.vy;
        p.life -= 0.0012;
        if (p.x < 0 || p.x > bgCanvas.width) p.vx *= -1;
        if (p.y < 0 || p.y > bgCanvas.height) p.vy *= -1;
        if (p.life <= 0) {
          p.x = Math.random() * bgCanvas.width;
          p.y = Math.random() * bgCanvas.height;
          p.life = Math.random() * 0.8 + 0.2;
        }
        bgCtx.globalAlpha = p.life * 0.6;
        bgCtx.fillStyle = '#d6b87c';
        bgCtx.beginPath();
        bgCtx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        bgCtx.fill();
      });
      bgCtx.globalAlpha = 1;
      if (!root.classList.contains('reduced-motion')) {
        bgAnimationId = requestAnimationFrame(drawBackdrop);
      }
    }

    function startBackdrop() {
      if (!bgCanvas || !bgCtx) return;
      cancelAnimationFrame(bgAnimationId);
      if (root.classList.contains('reduced-motion')) {
        drawBackdrop();
        return;
      }
      bgAnimationId = requestAnimationFrame(drawBackdrop);
    }

    const geometryCanvas = document.getElementById('geometry-canvas');
    const geoCtx = geometryCanvas ? geometryCanvas.getContext('2d') : null;
    let geoAnimationId = null;
    let geoTime = 0;
    let recursionDepth = 6;
    let phiRatio = 1.61;
    let rotationSpeed = 0.3;
    let complexity = 12;

    function resizeGeometry() {
      if (!geometryCanvas) return;
      geometryCanvas.width = geometryCanvas.clientWidth;
      geometryCanvas.height = geometryCanvas.clientHeight;
    }

    function drawFlower(x, y, r, depth) {
      if (!geoCtx || depth <= 0) return;
      geoCtx.strokeStyle = `hsla(${(geoTime * 45) % 360},70%,68%,${depth / recursionDepth})`;
      geoCtx.lineWidth = 0.6;
      geoCtx.beginPath();
      geoCtx.arc(x, y, r, 0, Math.PI * 2);
      geoCtx.stroke();
      for (let i = 0; i < complexity; i += 6) {
        const angle = (Math.PI * 2 / complexity) * (i + 1) + geoTime * rotationSpeed;
        const nx = x + Math.cos(angle) * r;
        const ny = y + Math.sin(angle) * r;
        geoCtx.beginPath();
        geoCtx.arc(nx, ny, r / phiRatio, 0, Math.PI * 2);
        geoCtx.stroke();
        if (depth > 1) {
          drawFlower(nx, ny, r / phiRatio, depth - 1);
        }
      }
    }

    function renderGeometry() {
      if (!geometryCanvas || !geoCtx) return;
      geoCtx.clearRect(0, 0, geometryCanvas.width, geometryCanvas.height);
      const radius = Math.min(geometryCanvas.width, geometryCanvas.height) / 3.2;
      drawFlower(geometryCanvas.width / 2, geometryCanvas.height / 2, radius, recursionDepth);
      if (!root.classList.contains('reduced-motion')) {
        geoTime += 0.015;
        geoAnimationId = requestAnimationFrame(renderGeometry);
      }
    }

    function startGeometry() {
      if (!geometryCanvas || !geoCtx) return;
      cancelAnimationFrame(geoAnimationId);
      renderGeometry();
    }

    document.getElementById('recursion')?.addEventListener('input', (event) => {
      recursionDepth = Number(event.target.value);
      startGeometry();
    });
    document.getElementById('phi')?.addEventListener('input', (event) => {
      phiRatio = 1 + Number(event.target.value) / 100;
      startGeometry();
    });
    document.getElementById('rotation')?.addEventListener('input', (event) => {
      rotationSpeed = Number(event.target.value) / 120;
      startGeometry();
    });
    document.getElementById('complexity')?.addEventListener('input', (event) => {
      complexity = Number(event.target.value);
      startGeometry();
    });

    const freqReadout = document.getElementById('freqReadout');
    document.getElementById('palette')?.addEventListener('click', (event) => {
      const swatch = event.target.closest('.color-swatch');
      if (!swatch || !freqReadout) return;
      const hz = swatch.getAttribute('data-freq') || '432';
      freqReadout.textContent = `${hz} Hz`;
    });

    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const closeModalBtn = modal?.querySelector('.close-modal');

    function openModal(title, description) {
      if (!modal || !modalTitle || !modalBody || !closeModalBtn) return;
      modalTitle.textContent = title;
      modalBody.textContent = description;
      modal.removeAttribute('hidden');
      closeModalBtn.focus();
    }

    function closeModal() {
      if (!modal) return;
      modal.setAttribute('hidden', '');
    }

    closeModalBtn?.addEventListener('click', closeModal);
    modal?.addEventListener('click', (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });
    window.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && modal && !modal.hasAttribute('hidden')) {
        closeModal();
      }
    });

    document.querySelectorAll('.module-card').forEach((card) => {
      card.addEventListener('click', () => {
        openModal(card.dataset.title || 'Module', card.dataset.description || 'Details forthcoming.');
      });
      card.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          openModal(card.dataset.title || 'Module', card.dataset.description || 'Details forthcoming.');
        }
      });
    });

    function refreshMotionState() {
      setCalmButtonState();
      seedParticles();
      startBackdrop();
      startGeometry();
    }

    window.addEventListener('resize', () => {
      resizeBg();
      resizeGeometry();
      refreshMotionState();
    });

    resizeBg();
    resizeGeometry();
    refreshMotionState();

    (function(){
      const canvas = document.querySelector('.geometric-canvas');
      if (!canvas) return;
      let ticking = false;
      function updateParallax(){
        if (root.classList.contains('reduced-motion')) {
          canvas.style.transform = '';
          ticking = false; return;
        }
        const y = window.scrollY * 0.5;
        canvas.style.transform = `translateY(${y}px)`;
        ticking = false;
      }
      window.addEventListener('scroll', function(){
        if (!ticking){ requestAnimationFrame(updateParallax); ticking = true; }
      }, { passive:true });
    })();
  </script>
</body>
</html>
