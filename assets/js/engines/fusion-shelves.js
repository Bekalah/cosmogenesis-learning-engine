(()=>{ â€œuse strictâ€; let artifacts=[],grimoires={},provenance={},fusionists={}; const qs=s=>document.querySelector(s); function safeFetchJSON(path){ return fetch(path,{cache:â€œno-storeâ€}).then(r=>{ if(!r.ok) throw new Error(â€œMissing: â€œ+path); return r.json(); }); } function el(tag,attrs={},children=[]){ const n=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>{ if(k===â€œclassâ€) n.className=v; else if(k.startsWith(â€œonâ€)&&typeof v===â€œfunctionâ€) n.addEventListener(k.slice(2),v); else n.setAttribute(k,v); }); children.forEach(c=>n.appendChild(typeof c===â€œstringâ€?document.createTextNode(c):c)); return n; } async function loadData(){ const [g,f,a,p]=await Promise.all([ safeFetchJSON(â€/assets/data/fusion/grimoires.jsonâ€), safeFetchJSON(â€/assets/data/fusion/fusionist_registry.jsonâ€), safeFetchJSON(â€/assets/data/fusion/artifacts.jsonâ€), safeFetchJSON(â€/assets/data/fusion/provenance.jsonâ€) ]); grimoires=Object.fromEntries(g.items.map(x=>[x.id,x])); fusionists=Object.fromEntries(f.fusionists.map(x=>[x.id,x])); provenance=Object.fromEntries(p.records.map(x=>[x.id,x])); artifacts=a.artifacts.map(x=>Object.assign({},x)); if(localStorage.getItem(â€œsophia7_spawn_allâ€)===â€œtrueâ€){ artifacts.forEach(x=>x.unlocked=true); } renderStairs(); renderShelves(); window._grimoires=grimoires; window._provenance=provenance; window.artifacts=artifacts; } function renderStairs(){ const stairs=qs(â€#stairsâ€); stairs.innerHTML=â€â€; for(let i=1;i<=33;i++){ const b=el(â€œbuttonâ€,{class:â€œstairâ€,onclick:()=>scrollToShelf(i)},[String(i)]); stairs.appendChild(b); } } function shelfIndexFromLocation(loc){ const m=/shelf(\d+)/.exec(loc||â€â€); return m?parseInt(m[1],10):null; } function groupedByShelf(){ const map=new Map(); artifacts.forEach(a=>{ const idx=shelfIndexFromLocation(a.location)||0; if(!map.has(idx)) map.set(idx,[]); map.get(idx).push(a); }); return [â€¦map.entries()].sort((a,b)=>a[0]-b[0]); } function renderShelves(){ const root=qs(â€#shelvesâ€); root.innerHTML=â€â€; groupedByShelf().forEach(([shelf,items])=>{ const shelfEl=el(â€œsectionâ€,{â€œaria-labelâ€:â€œShelf â€œ+shelf,class:â€œshelfâ€},[ el(â€œh2â€,{},[â€œShelf â€œ,String(shelf)]) ]); items.forEach(item=>{ const unlocked=item.unlocked===true; const btn=el(â€œbuttonâ€,{class:â€œdrawerâ€,onclick:()=>onOpenArtifact(item)},[ (unlocked?â€œğŸ“– â€œ:â€œğŸ”’ â€œ), item.title ]); btn.disabled=false; shelfEl.appendChild(btn); }); root.appendChild(shelfEl); }); } function onOpenArtifact(artifact){ if(!artifact.unlocked && localStorage.getItem(â€œsophia7_spawn_allâ€)!==â€œtrueâ€){ artifact.unlocked=true; } renderWorkbench(artifact); renderShelves(); } function scrollToShelf(num){ const target=[â€¦document.querySelectorAll(â€.shelfâ€)].find(s=>s.querySelector(â€œh2â€)?.textContent?.includes(â€ â€œ+num)); if(target) target.scrollIntoView({behavior:â€œsmoothâ€,block:â€œstartâ€}); } window.renderShelves=renderShelves; window.onOpenArtifact=onOpenArtifact; document.addEventListener(â€œDOMContentLoadedâ€,loadData); })();
