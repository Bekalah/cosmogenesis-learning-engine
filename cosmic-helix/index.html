<!doctype html>
<html lang='en'>
<head>
  <meta charset='utf-8'>
  <title>Cosmic Helix Renderer (ND-safe, Offline)</title>
  <meta name='viewport' content='width=device-width,initial-scale=1,viewport-fit=cover'>
  <meta name='color-scheme' content='light dark'>
  <style>
    /* ND-safe shell: calm contrast, no motion, layered geometry remains legible. */
    :root {
      --bg: #0b0b12;
      --ink: #e8e8f0;
      --muted: #a6a6c1;
      --outline: #1d1d2a;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--ink);
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--outline);
    }

    .status {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    #stage {
      display: block;
      margin: 16px auto;
      width: 1440px;
      height: 900px;
      max-width: calc(100vw - 32px);
      max-height: calc(100vh - 160px);
      background: var(--bg);
      box-shadow: 0 0 0 1px var(--outline);
    }

    .note {
      max-width: 900px;
      margin: 0 auto 24px;
      padding: 0 16px;
      color: var(--muted);
    }

    canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
  </style>
</head>
<body>
  <header>
    <div><strong>Cosmic Helix Renderer</strong> — layered sacred geometry (offline, ND-safe)</div>
    <div class='status' id='status'>Loading palette…</div>
  </header>

  <canvas id='stage' width='1440' height='900' aria-label='Layered sacred geometry canvas'></canvas>
  <p class='note'>Static renderer encoding the Vesica grid, Tree-of-Life nodes and paths, Fibonacci curve, and a static double-helix lattice. Open this file directly; no animation, no external libraries.</p>

  <script type='module'>
    import { renderHelix } from './js/helix-renderer.mjs';

    const statusEl = document.getElementById('status');
    const canvas = document.getElementById('stage');
    const ctx = canvas.getContext('2d');

    const FALLBACK_PALETTE = {
      bg: '#0b0b12',
      ink: '#e8e8f0',
      muted: '#a6a6c1',
      layers: ['#b1c7ff', '#89f7fe', '#a0ffa1', '#ffd27f', '#f5a3ff', '#d0d0e6']
    };

    const NUM = {
      THREE: 3,
      SEVEN: 7,
      NINE: 9,
      ELEVEN: 11,
      TWENTYTWO: 22,
      THIRTYTHREE: 33,
      NINETYNINE: 99,
      ONEFORTYFOUR: 144
    };

    function updateTheme(palette) {
      // ND-safe: direct CSS variables keep the calm palette without flicker.
      const root = document.documentElement;
      root.style.setProperty('--bg', palette.bg);
      root.style.setProperty('--ink', palette.ink);
      root.style.setProperty('--muted', palette.muted || palette.ink);
    }

    async function loadPalette() {
      try {
        const response = await fetch('./data/palette.json', { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(String(response.status));
        }
        const data = await response.json();
        return { palette: data, notice: '' };
      } catch (error) {
        // Offline-first: file:// fetch may fail, so we fall back silently and surface a calm notice.
        return { palette: FALLBACK_PALETTE, notice: 'Palette fallback active.' };
      }
    }

    function setStatus(message) {
      statusEl.textContent = message;
    }

    async function init() {
      if (!ctx) {
        setStatus('Canvas context unavailable in this browser.');
        return;
      }

      const { palette, notice } = await loadPalette();
      updateTheme(palette);

      const result = renderHelix(ctx, {
        width: canvas.width,
        height: canvas.height,
        palette,
        NUM,
        notice
      });

      if (result.ok) {
        const suffix = notice ? ' Palette fallback active.' : ' Palette loaded.';
        setStatus('Renderer ready.' + suffix);
      } else {
        setStatus('Renderer error: ' + (result.reason || 'unknown'));
      }
    }

    init();
  </script>
</body>
</html>
